
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>kicost.spreadsheet &#8212; kicost 1.1.3 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">kicost 1.1.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kicost.spreadsheet</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*- </span>
<span class="c1"># MIT license</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2019 by XESS Corporation / Hildo Guillardi Júnior</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in</span>
<span class="c1"># all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<span class="c1"># THE SOFTWARE.</span>

<span class="c1"># Author information.</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Hildo Guillardi Júnior&#39;</span>
<span class="n">__webpage__</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/hildogjr/&#39;</span>
<span class="n">__company__</span> <span class="o">=</span> <span class="s1">&#39;University of Campinas - Brazil&#39;</span>

<span class="kn">from</span> <span class="nn">.global_vars</span> <span class="k">import</span> <span class="o">*</span> <span class="c1"># Debug, language and default configurations.</span>

<span class="c1"># Python libraries.</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">re</span> <span class="c1"># Regular expression parser.</span>
<span class="kn">import</span> <span class="nn">xlsxwriter</span> <span class="c1"># XLSX file interpreter.</span>
<span class="kn">from</span> <span class="nn">xlsxwriter.utility</span> <span class="k">import</span> <span class="n">xl_rowcol_to_cell</span><span class="p">,</span> <span class="n">xl_range</span><span class="p">,</span> <span class="n">xl_range_abs</span>
<span class="kn">from</span> <span class="nn">babel</span> <span class="k">import</span> <span class="n">numbers</span> <span class="c1"># For currency presentation.</span>

<span class="c1"># KiCost libraries.</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">__version__</span> <span class="c1"># Version control by @xesscorp and collaborator.</span>
<span class="kn">from</span> <span class="nn">.distributors.global_vars</span> <span class="k">import</span> <span class="n">distributor_dict</span> <span class="c1"># Distributors names and definitions to use in the spreadsheet.</span>
<span class="kn">from</span> <span class="nn">.edas.tools</span> <span class="k">import</span> <span class="n">partgroup_qty</span><span class="p">,</span> <span class="n">order_refs</span><span class="p">,</span> <span class="n">PART_REF_REGEX</span><span class="p">,</span> <span class="n">SUB_SEPRTR</span>

<span class="kn">from</span> <span class="nn">currency_converter</span> <span class="k">import</span> <span class="n">CurrencyConverter</span>
<span class="n">currency_convert</span> <span class="o">=</span> <span class="n">CurrencyConverter</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;create_spreadsheet&#39;</span><span class="p">]</span>


<span class="n">PURCHASE_DESCRIPTION_SEPRTR</span> <span class="o">=</span> <span class="n">SEPRTR</span> <span class="c1"># Purchase description separator.</span>

<span class="c1"># Currency format and symbol definition (placed default values here, it will be replaced by the user asked currency).</span>
<span class="n">CURRENCY_ALPHA3</span> <span class="o">=</span> <span class="n">DEFAULT_CURRENCY</span>
<span class="n">CURRENCY_SYMBOL</span> <span class="o">=</span> <span class="s1">&#39;US$&#39;</span>
<span class="n">CURRENCY_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">WORKBOOK</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Regular expression to the link for one datasheet.</span>
<span class="n">DATASHEET_LINK_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^(http(s)?:\/\/)?(www.)?[0-9a-z\.]+\/[0-9a-z\.\/\%\-\_]+(.pdf)?$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="c1"># Extra information characteristics of the components gotten in the page that will be displayed as comment in the &#39;cat#&#39; column.</span>
<span class="n">EXTRA_INFO_DISPLAY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;tolerance&#39;</span><span class="p">,</span> <span class="s1">&#39;footprint&#39;</span><span class="p">,</span> <span class="s1">&#39;power&#39;</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_coeff&#39;</span><span class="p">,</span> <span class="s1">&#39;manf&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">]</span>


<span class="c1"># About and credit message at the end of the spreadsheet.</span>
<span class="n">ABOUT_MSG</span><span class="o">=</span><span class="s1">&#39;KiCost</span><span class="se">\N{REGISTERED SIGN}</span><span class="s1"> v.&#39;</span> <span class="o">+</span> <span class="n">__version__</span>


<div class="viewcode-block" id="create_spreadsheet"><a class="viewcode-back" href="../../kicost.html#kicost.spreadsheet.create_spreadsheet">[docs]</a><span class="k">def</span> <span class="nf">create_spreadsheet</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">prj_info</span><span class="p">,</span> <span class="n">spreadsheet_filename</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">DEFAULT_CURRENCY</span><span class="p">,</span>
                       <span class="n">collapse_refs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supress_cat_url</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">variant</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a spreadsheet using the info for the parts (including their HTML trees).&#39;&#39;&#39;</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEBUG_OVERVIEW</span><span class="p">,</span> <span class="s1">&#39;Creating the </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1"> spreadsheet...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">spreadsheet_filename</span><span class="p">))</span> <span class="p">)</span>
    
    <span class="n">MAX_LEN_WORKSHEET_NAME</span> <span class="o">=</span> <span class="mi">31</span> <span class="c1"># Microsoft Excel allows a 31 characters longer</span>
                                <span class="c1"># string for the worksheet name, Google</span>
                                <span class="c1">#Spreadsheet 100 and LibreOffice Calc have no limit.</span>
    <span class="n">DEFAULT_BUILD_QTY</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Default value for number of boards to build.</span>
    <span class="k">global</span> <span class="n">WORKSHEET_NAME</span>
    <span class="n">WORKSHEET_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">spreadsheet_filename</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Default name for pricing worksheet.</span>

    <span class="k">global</span> <span class="n">CURRENCY_SYMBOL</span>
    <span class="k">global</span> <span class="n">CURRENCY_FORMAT</span>
    <span class="k">global</span> <span class="n">CURRENCY_ALPHA3</span>
    <span class="n">CURRENCY_ALPHA3</span> <span class="o">=</span> <span class="n">currency</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">CURRENCY_SYMBOL</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">get_currency_symbol</span><span class="p">(</span>
                        <span class="n">CURRENCY_ALPHA3</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span>
                        <span class="p">)</span>
    <span class="n">CURRENCY_FORMAT</span> <span class="o">=</span> <span class="n">CURRENCY_SYMBOL</span> <span class="o">+</span> <span class="s1">&#39;#,##0.00&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Append an indication of the variant to the worksheet title.</span>
        <span class="c1"># Remove any special characters that might be illegal in a </span>
        <span class="c1"># worksheet name since the variant might be a regular expression.</span>
        <span class="c1"># Fix the maximum worksheet name, priorize the variant string cutting</span>
        <span class="c1"># the board project.</span>
        <span class="n">variant</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[\[\]</span><span class="se">\\</span><span class="s1">\/\|\?\*\:\(\)]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span>
                            <span class="n">variant</span><span class="p">[:(</span><span class="n">MAX_LEN_WORKSHEET_NAME</span><span class="p">)])</span>
        <span class="n">WORKSHEET_NAME</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">WORKSHEET_NAME</span> <span class="o">=</span> <span class="n">WORKSHEET_NAME</span><span class="p">[:(</span><span class="n">MAX_LEN_WORKSHEET_NAME</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">variant</span><span class="p">))]</span>
        <span class="n">WORKSHEET_NAME</span> <span class="o">+=</span> <span class="n">variant</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">WORKSHEET_NAME</span> <span class="o">=</span> <span class="n">WORKSHEET_NAME</span><span class="p">[:</span><span class="n">MAX_LEN_WORKSHEET_NAME</span><span class="p">]</span>
    
    <span class="c1"># Create spreadsheet file.</span>
    <span class="k">with</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">spreadsheet_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">workbook</span><span class="p">:</span>
    
        <span class="c1"># Create the various format styles used by various spreadsheet items.</span>
        <span class="n">WRK_HDR_FORMAT</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#303030&#39;</span><span class="p">,</span>
                <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
            <span class="p">}</span>
        <span class="n">wrk_formats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;global&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span><span class="n">WRK_HDR_FORMAT</span><span class="p">),</span>
            <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span>
                <span class="s1">&#39;text_wrap&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}),</span>
            <span class="s1">&#39;board_qty&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;total_cost_label&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span>
                <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;unit_cost_label&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span>
                <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;total_cost_currency&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_format&#39;</span><span class="p">:</span> <span class="n">CURRENCY_FORMAT</span><span class="p">,</span>
                <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;unit_cost_currency&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_format&#39;</span><span class="p">:</span> <span class="n">CURRENCY_FORMAT</span><span class="p">,</span>
                <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;proj_info_field&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;proj_info&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;part_format&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span>
            <span class="p">}),</span>
            <span class="s1">&#39;part_format_obsolete&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span> <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#c000c0&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;found_part_pct&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;italic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
            <span class="p">}),</span>
            <span class="s1">&#39;best_price&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#80FF80&#39;</span><span class="p">,</span> <span class="p">}),</span>
            <span class="s1">&#39;not_manf_codes&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#AAAAAA&#39;</span><span class="p">}),</span>
            <span class="s1">&#39;not_available&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF0000&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span><span class="s1">&#39;white&#39;</span><span class="p">}),</span>
            <span class="s1">&#39;order_too_much&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF0000&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span><span class="s1">&#39;white&#39;</span><span class="p">}),</span>
            <span class="s1">&#39;order_min_qty&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFFF00&#39;</span><span class="p">}),</span>
            <span class="s1">&#39;too_few_available&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF9900&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span><span class="s1">&#39;black&#39;</span><span class="p">}),</span>
            <span class="s1">&#39;too_few_purchased&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFFF00&#39;</span><span class="p">}),</span>
            <span class="s1">&#39;not_stocked&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#909090&#39;</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">}),</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;num_format&#39;</span><span class="p">:</span> <span class="n">CURRENCY_FORMAT</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">}),</span>
        <span class="p">}</span>

        <span class="c1"># Add the distinctive header format for each distributor to the `dict` of formats.</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">distributor_dict</span><span class="p">:</span>
            <span class="n">hdr_format</span> <span class="o">=</span> <span class="n">WRK_HDR_FORMAT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdr_format</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">distributor_dict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
            <span class="n">wrk_formats</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span><span class="n">hdr_format</span><span class="p">)</span>

        <span class="c1"># Create the worksheet that holds the pricing information.</span>
        <span class="n">wks</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="n">WORKSHEET_NAME</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">WORKBOOK</span>
        <span class="n">WORKBOOK</span> <span class="o">=</span> <span class="n">workbook</span>

        <span class="c1"># Set the row &amp; column for entering the part information in the sheet.</span>
        <span class="n">START_COL</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">BOARD_QTY_ROW</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">UNIT_COST_ROW</span> <span class="o">=</span> <span class="n">BOARD_QTY_ROW</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">TOTAL_COST_ROW</span> <span class="o">=</span> <span class="n">BOARD_QTY_ROW</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">START_ROW</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">prj_info</span><span class="p">)</span>
        <span class="n">LABEL_ROW</span> <span class="o">=</span> <span class="n">START_ROW</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">COL_HDR_ROW</span> <span class="o">=</span> <span class="n">LABEL_ROW</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">FIRST_PART_ROW</span> <span class="o">=</span> <span class="n">COL_HDR_ROW</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">LAST_PART_ROW</span> <span class="o">=</span> <span class="n">COL_HDR_ROW</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">next_row</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Load the global part information (not distributor-specific) into the sheet.</span>
        <span class="c1"># next_col = the column immediately to the right of the global data.</span>
        <span class="c1"># qty_col = the column where the quantity needed of each part is stored.</span>
        <span class="n">next_line</span><span class="p">,</span> <span class="n">next_col</span><span class="p">,</span> <span class="n">refs_col</span><span class="p">,</span> <span class="n">qty_col</span><span class="p">,</span> <span class="n">columns_global</span> <span class="o">=</span> <span class="n">add_globals_to_worksheet</span><span class="p">(</span>
            <span class="n">wks</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">,</span> <span class="n">START_ROW</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="n">TOTAL_COST_ROW</span><span class="p">,</span>
            <span class="n">parts</span><span class="p">,</span> <span class="n">user_fields</span><span class="p">,</span> <span class="n">collapse_refs</span><span class="p">)</span>
        <span class="c1"># Create a defined range for the global data.</span>
        <span class="n">workbook</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span>
            <span class="s1">&#39;global_part_data&#39;</span><span class="p">,</span> <span class="s1">&#39;=</span><span class="si">{wks_name}</span><span class="s1">!</span><span class="si">{data_range}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">wks_name</span><span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">WORKSHEET_NAME</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                <span class="n">data_range</span><span class="o">=</span><span class="n">xl_range_abs</span><span class="p">(</span><span class="n">START_ROW</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="n">LAST_PART_ROW</span><span class="p">,</span>
                                        <span class="n">next_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i_prj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prj_info</span><span class="p">)):</span>
            <span class="c1"># Add project information to track the project (in a printed version</span>
            <span class="c1"># of the BOM) and the date because of price variations.</span>
            <span class="n">i_prj_str</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prj_info</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span>
                      <span class="s1">&#39;Prj</span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">),</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info_field&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">START_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">prj_info</span><span class="p">[</span><span class="n">i_prj</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="s1">&#39;Co.:&#39;</span><span class="p">,</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info_field&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">START_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">prj_info</span><span class="p">[</span><span class="n">i_prj</span><span class="p">][</span><span class="s1">&#39;company&#39;</span><span class="p">],</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span>
                      <span class="s1">&#39;Prj date:&#39;</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info_field&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">START_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">prj_info</span><span class="p">[</span><span class="n">i_prj</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span>

            <span class="c1"># Create the cell where the quantity of boards to assemble is entered.</span>
            <span class="c1"># Place the board qty cells near the right side of the global info.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Board Qty</span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">),</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;board_qty&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEFAULT_BUILD_QTY</span><span class="p">,</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;board_qty&#39;</span><span class="p">])</span>  <span class="c1"># Set initial board quantity.</span>
            <span class="c1"># Define the named cell where the total board quantity can be found.</span>
            <span class="n">workbook</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span><span class="s1">&#39;BoardQty</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">),</span>
                <span class="s1">&#39;=</span><span class="si">{wks_name}</span><span class="s1">!</span><span class="si">{cell_ref}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">wks_name</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">WORKSHEET_NAME</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                    <span class="n">cell_ref</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                           <span class="n">row_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">col_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
            
            <span class="c1"># Create the cell to show total cost of board parts for each distributor.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Total Cost</span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">),</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_label&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">next_row</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Use the minimum extend price across distributors not taking account available quantities.&#39;</span><span class="p">)</span>
            <span class="c1"># Define the named cell where the total cost can be found.</span>
            <span class="n">workbook</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span><span class="s1">&#39;TotalCost</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">),</span>
                            <span class="s1">&#39;=</span><span class="si">{wks_name}</span><span class="s1">!</span><span class="si">{cell_ref}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">wks_name</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">WORKSHEET_NAME</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                                <span class="n">cell_ref</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">next_row</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                                                           <span class="n">next_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">row_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="p">)</span>

            <span class="c1"># Create the cell to show unit cost of (each project) board parts.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Unit Cost</span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">),</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;unit_cost_label&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="s2">&quot;=TotalCost</span><span class="si">{}</span><span class="s2">/BoardQty</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj_str</span><span class="p">,</span> <span class="n">i_prj_str</span><span class="p">),</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;unit_cost_currency&#39;</span><span class="p">])</span>

            <span class="n">next_row</span> <span class="o">+=</span> <span class="mi">3</span>

        <span class="c1"># Add general information of the scrap to track price modifications.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span>
                  <span class="s1">&#39;$ date:&#39;</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info_field&#39;</span><span class="p">])</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">START_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span>
        <span class="c1"># Add the total cost of all projects together.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prj_info</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Create the row to show total cost of board parts for each distributor.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Total Prjs Cost:&#39;</span><span class="p">,</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_label&#39;</span><span class="p">])</span>
            <span class="c1"># Define the named cell where the total cost can be found.</span>
            <span class="n">workbook</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span><span class="s1">&#39;TotalCost&#39;</span><span class="p">,</span> <span class="s1">&#39;=</span><span class="si">{wks_name}</span><span class="s1">!</span><span class="si">{cell_ref}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">wks_name</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">WORKSHEET_NAME</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                            <span class="n">cell_ref</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">next_row</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">row_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">col_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">next_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Freeze view of the global information and the column headers, but</span>
        <span class="c1"># allow the distributor-specific part info to scroll.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">freeze_panes</span><span class="p">(</span><span class="n">COL_HDR_ROW</span><span class="p">,</span> <span class="n">next_col</span><span class="p">)</span>

        <span class="c1"># Make a list of alphabetically-ordered distributors with web distributors before locals.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEBUG_OVERVIEW</span><span class="p">,</span> <span class="s1">&#39;Sorting the distributors...&#39;</span><span class="p">)</span>
        <span class="n">web_dists</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">distributor_dict</span> <span class="k">if</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">])</span>
        <span class="n">local_dists</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">distributor_dict</span> <span class="k">if</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">])</span>
        <span class="n">dist_list</span> <span class="o">=</span> <span class="n">web_dists</span> <span class="o">+</span> <span class="n">local_dists</span>

        <span class="c1"># Load the part information from each distributor into the sheet.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEBUG_OVERVIEW</span><span class="p">,</span> <span class="s1">&#39;Writing the distributor part information...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">dist_list</span><span class="p">:</span>
            <span class="n">dist_start_col</span> <span class="o">=</span> <span class="n">next_col</span>
            <span class="n">next_col</span> <span class="o">=</span> <span class="n">add_dist_to_worksheet</span><span class="p">(</span><span class="n">wks</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">,</span> <span class="n">columns_global</span><span class="p">,</span>
                                            <span class="n">START_ROW</span><span class="p">,</span> <span class="n">dist_start_col</span><span class="p">,</span>
                                            <span class="n">UNIT_COST_ROW</span><span class="p">,</span> <span class="n">TOTAL_COST_ROW</span><span class="p">,</span>
                                             <span class="n">refs_col</span><span class="p">,</span> <span class="n">qty_col</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">supress_cat_url</span><span class="p">)</span>
            <span class="c1"># Create a defined range for each set of distributor part data.</span>
            <span class="n">workbook</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_part_data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">),</span> <span class="s1">&#39;=</span><span class="si">{wks_name}</span><span class="s1">!</span><span class="si">{data_range}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">wks_name</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">WORKSHEET_NAME</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                    <span class="n">data_range</span><span class="o">=</span><span class="n">xl_range_abs</span><span class="p">(</span><span class="n">START_ROW</span><span class="p">,</span> <span class="n">dist_start_col</span><span class="p">,</span>
                                            <span class="n">LAST_PART_ROW</span><span class="p">,</span> <span class="n">next_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># Add the KiCost package information at the end of the spreadsheet to debug</span>
        <span class="c1"># information at the forum and &quot;advertising&quot;.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">START_COL</span><span class="p">,</span> <span class="n">ABOUT_MSG</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;proj_info&#39;</span><span class="p">])</span></div>


<span class="k">def</span> <span class="nf">add_globals_to_worksheet</span><span class="p">(</span><span class="n">wks</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span>
                             <span class="n">total_cost_row</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">user_fields</span><span class="p">,</span> <span class="n">collapse_refs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Add global part data to the spreadsheet.&#39;&#39;&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEBUG_OVERVIEW</span><span class="p">,</span> <span class="s1">&#39;Writing the global part information...&#39;</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">CURRENCY_SYMBOL</span>
    <span class="k">global</span> <span class="n">CURRENCY_FORMAT</span>

    <span class="c1"># Columns for the various types of global part data.</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;refs&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Outline level (or hierarchy level) for this column.</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Refs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Column width (default in this case).</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Schematic identifier for each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Value&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Value of each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Desc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Description of each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;footprint&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Footprint&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;PCB footprint for each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;manf&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Manf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Manufacturer of each part.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;manf#&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Manf#&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;Manufacturer number for each part and link to it</span><span class="se">\&#39;</span><span class="s1">s datasheet (Ctrl-click).</span>
<span class="s1">Purple -&gt; Obsolete part detected by one of the distributors.&#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Qty&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;Total number of each part needed.</span>
<span class="s1">Gray -&gt; No manf# provided.</span>
<span class="s1">Red -&gt; No parts available.</span>
<span class="s1">Orange -&gt; Not enough parts available.</span>
<span class="s1">Yellow -&gt; Parts available, but haven&#39;t purchased enough.&#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;unit_price&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Minimum unit price for each part across all distributors.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;ext_price&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Ext$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>  <span class="c1"># Displays up to $9,999,999.99 without &quot;###&quot;.</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Minimum extended price for each part across all distributors.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># Remove not used columns by the field not founded in ALL the parts. This give</span>
    <span class="c1"># better visualization on notebooks (small screens) and optimization to print.</span>
    <span class="k">def</span> <span class="nf">remove_col_not_exist_parts</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">code</span><span class="p">]:</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">remove_column</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="c1"># All &#39;manf&#39; are empty.</span>
    <span class="n">remove_col_not_exist_parts</span><span class="p">(</span><span class="s1">&#39;manf&#39;</span><span class="p">)</span>
    <span class="n">remove_col_not_exist_parts</span><span class="p">(</span><span class="s1">&#39;desc&#39;</span><span class="p">)</span>

    <span class="c1"># Add quantity columns to deal with different quantities in the BOM files. The</span>
    <span class="c1"># original quantity column will be the total of each item. For check the number</span>
    <span class="c1"># of BOM files read, see the length of p[?][&#39;manf#_qty&#39;], if it is a `list()`</span>
    <span class="c1"># instance, if don&#39;t, the length is always `1`.</span>
    <span class="n">num_prj</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;manf#_qty&#39;</span><span class="p">,[]))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;manf#_qty&#39;</span><span class="p">,[]),</span><span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">num_prj</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i_prj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prj</span><span class="p">):</span>
            <span class="c1"># Add one column to quantify the quantity for each project.</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;qty_prj</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Qty.Prj</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Total number of each part needed to assembly the project </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">col</span> <span class="ow">and</span> <span class="n">k</span><span class="o">!=</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Enter user-defined fields into the global part data columns structure.</span>
    <span class="k">for</span> <span class="n">user_field</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">user_fields</span><span class="p">)):</span>
        <span class="c1"># Skip the user field if it&#39;s already in the list of data columns.</span>
        <span class="n">col_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">user_field_id</span> <span class="o">=</span> <span class="n">user_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user_field_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_ids</span><span class="p">:</span>
            <span class="c1"># Put user fields immediately to right of the &#39;desc&#39; column. </span>
            <span class="n">desc_col</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
            <span class="c1"># Push all existing fields to right of &#39;desc&#39; over by one column.</span>
            <span class="c1"># Use &#39;value&#39; if &#39;desc&#39; was removed due not value present in the BOM.</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">col_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">desc_col</span><span class="p">:</span>
                    <span class="n">columns</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Insert user field in the vacated space.</span>
            <span class="n">columns</span><span class="p">[</span><span class="n">user_field_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="n">desc_col</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">user_field</span><span class="p">,</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;User-defined field.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;static&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">start_row</span>  <span class="c1"># Start building global section at this row.</span>

    <span class="c1"># Add label for global section.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;Global Part Info&quot;</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">])</span>
    <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># Add column headers.</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">])</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;level&#39;</span><span class="p">]})</span>
    <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="n">num_parts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">=</span> <span class="n">row</span>  <span class="c1"># Starting row of part info.</span>
    <span class="n">PART_INFO_LAST_ROW</span> <span class="o">=</span> <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Last row of part info.</span>

    <span class="c1"># Add data for each part to the spreadsheet.</span>
    <span class="c1"># Order the references and collapse, if asked:</span>
    <span class="c1"># e.g. J3, J2, J1, J6 =&gt; J1, J2, J3 J6. # `collapse=False`</span>
    <span class="c1"># e.g. J3, J2, J1, J6 =&gt; J1-J3, J6.. # `collapse=True`</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="c1">#part.collapsed_refs = &#39;,&#39;.join( order_refs(part.refs, collapse=collapse_refs) )</span>
        <span class="n">part</span><span class="o">.</span><span class="n">collapsed_refs</span> <span class="o">=</span> <span class="n">order_refs</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">refs</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="n">collapse_refs</span><span class="p">)</span>

    <span class="c1"># Then, order the part references with priority ref prefix, ref num, and subpart num.</span>
    <span class="k">def</span> <span class="nf">get_ref_key</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">PART_REF_REGEX</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">collapsed_refs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;ref_num&#39;</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;subpart_num&#39;</span><span class="p">)]</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">get_ref_key</span><span class="p">)</span>

    <span class="c1"># Add the global part data to the spreadsheet.</span>
    <span class="n">used_currencies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>

        <span class="c1"># Enter part references.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;refs&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">part</span><span class="o">.</span><span class="n">collapsed_refs</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>

        <span class="c1"># Enter more static data for the part.</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;static&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Fields found in the XML are lower-cased, so do the same for the column key.</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field_name</span><span class="o">==</span><span class="s1">&#39;manf#&#39;</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;manf#&#39;</span><span class="p">)</span>
                    <span class="n">link</span>  <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datasheet&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Use the the datasheet link got in the distributor if not</span>
                            <span class="c1"># available any in the BOM / schematic.</span>
                            <span class="n">link</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">datasheet</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lifecycle</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">lifecycle</span>
                        <span class="k">if</span> <span class="n">lifecycle</span><span class="o">==</span><span class="s1">&#39;obsolete&#39;</span><span class="p">:</span>
                            <span class="n">cell_format</span> <span class="o">=</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format_obsolete&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cell_format</span> <span class="o">=</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">cell_format</span> <span class="o">=</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">]</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="n">link</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">DATASHEET_LINK_REGEX</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
                        <span class="c1"># Just put the link if is a valid format.</span>
                        <span class="n">wks</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;manf#&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                             <span class="n">link</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">string</span><span class="p">,</span> <span class="n">cell_format</span><span class="o">=</span><span class="n">cell_format</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wks</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                             <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">cell_format</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field_name</span><span class="o">==</span><span class="s1">&#39;footprint&#39;</span><span class="p">:</span>
                        <span class="c1">##TODO add future dependence of &quot;electro-grammar&quot; (https://github.com/kitspace/electro-grammar)</span>
                        <span class="n">field_value_footprint</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\:(.*)&#39;</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">field_value_footprint</span><span class="p">:</span>
                            <span class="n">field_value</span> <span class="o">=</span> <span class="n">field_value_footprint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">field_value</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                    <span class="n">wks</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                                 <span class="n">field_value</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Enter total part quantity needed.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">qty</span> <span class="o">=</span> <span class="n">partgroup_qty</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># Multifiles BOM case, write each quantity and after,</span>
                <span class="c1"># in the &#39;qty&#39; column the total quantity as ceil of</span>
                <span class="c1"># the total quantity (to ceil use a Microsoft Excel</span>
                <span class="c1"># compatible function.</span>
                <span class="k">for</span> <span class="n">i_prj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qty</span><span class="p">)):</span>
                    <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span>
                          <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty_prj</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                          <span class="n">qty</span><span class="p">[</span><span class="n">i_prj</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;BoardQty</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)),</span>
                          <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;=CEILING(SUM(</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">),1)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty_prj0&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]),</span>
                        <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                          <span class="n">qty</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;BoardQty&#39;</span><span class="p">),</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Gather the cell references for calculating minimum unit price and part availability.</span>
        <span class="n">dist_unit_prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist_qty_avail</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist_qty_purchased</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist_code_avail</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist_ext_prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">distributor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="c1"># Get the currencies used among all distributors.</span>
            <span class="n">used_currencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">currency</span><span class="p">[</span><span class="n">dist</span><span class="p">])</span>

            <span class="c1"># Get the name of the data range for this distributor.</span>
            <span class="n">dist_data_rng</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_part_data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

            <span class="c1"># Get the contents of the unit price cell for this part (row) and distributor (column+offset).</span>
            <span class="n">dist_unit_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;INDIRECT(ADDRESS(ROW(),COLUMN(</span><span class="si">{}</span><span class="s1">)+2))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist_data_rng</span><span class="p">))</span>

            <span class="c1"># Get the contents of the quantity purchased cell for this part and distributor</span>
            <span class="c1"># unless the unit price is not a number in which case return 0.</span>
            <span class="n">dist_qty_purchased</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;IF(ISNUMBER(INDIRECT(ADDRESS(ROW(),COLUMN(</span><span class="si">{0}</span><span class="s1">)+2))),INDIRECT(ADDRESS(ROW(),COLUMN(</span><span class="si">{0}</span><span class="s1">)+1)),0)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist_data_rng</span><span class="p">))</span>

            <span class="c1"># Get the contents of the quantity available cell of this part from this distributor.</span>
            <span class="n">dist_qty_avail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;INDIRECT(ADDRESS(ROW(),COLUMN(</span><span class="si">{}</span><span class="s1">)+0))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist_data_rng</span><span class="p">))</span>

            <span class="c1"># Get the contents of the manufacture and distributors codes.</span>
            <span class="n">dist_code_avail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;ISBLANK(INDIRECT(ADDRESS(ROW(),COLUMN(</span><span class="si">{}</span><span class="s1">)+4)))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist_data_rng</span><span class="p">))</span>

            <span class="c1"># Get the contents of the manufacture and distributors codes.</span>
            <span class="n">dist_ext_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;INDIRECT(ADDRESS(ROW(),COLUMN(</span><span class="si">{}</span><span class="s1">)+3))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist_data_rng</span><span class="p">))</span>

        <span class="c1"># If part do not have manf# code or distributor codes, color quantity cell gray.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
            <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;formula&#39;</span><span class="p">,</span>
                <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;=AND(ISBLANK(</span><span class="si">{g}</span><span class="s1">),</span><span class="si">{d}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">g</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;manf#&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]),</span> <span class="c1"># Manf# column also have to be blank.</span>
                    <span class="n">d</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_code_avail</span><span class="p">)</span> <span class="k">if</span> <span class="n">dist_code_avail</span> <span class="k">else</span> <span class="s1">&#39;TRUE()&#39;</span><span class="p">)</span>
                 <span class="p">),</span>
                <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;not_manf_codes&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Enter the spreadsheet formula for calculating the minimum extended price (based on the unit price found on next formula).</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
            <span class="s1">&#39;=iferror(</span><span class="si">{qty}</span><span class="s1">*</span><span class="si">{unit_price}</span><span class="s1">,&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">qty</span>        <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]),</span>
                <span class="n">unit_price</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">])</span>
            <span class="p">),</span>
            <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># If not asked to scrape, to correlate the prices and available quantities.</span>
        <span class="k">if</span> <span class="n">distributor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Enter the spreadsheet formula to find this part&#39;s minimum unit price across all distributors.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="s1">&#39;=MINA(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_unit_prices</span><span class="p">)),</span>
                <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># If part is unavailable from all distributors, color quantity cell red.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;formula&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;=IF(SUM(</span><span class="si">{}</span><span class="s1">)=0,1,0)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_qty_avail</span><span class="p">)),</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;not_available&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># If total available part quantity is less than needed quantity, color cell orange. </span>
            <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;=SUM(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_qty_avail</span><span class="p">)),</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;too_few_available&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># If total purchased part quantity is less than needed quantity, color cell yellow. </span>
            <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;=SUM(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_qty_purchased</span><span class="p">)),</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;too_few_purchased&#39;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Enter part shortage quantity.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                      <span class="mi">0</span><span class="p">)</span>  <span class="c1"># slack quantity. (Not handled, yet.)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># Sum the extended prices for all the parts to get the total minimum cost.</span>
    <span class="c1"># If have read multiple BOM file calculate it by `SUMPRODUCT()` of the</span>
    <span class="c1"># board project quantity components &#39;qty_prj*&#39; by unitary price &#39;Unit$&#39;.</span>
    <span class="n">total_cost_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">unit_price_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="n">unit_price_range</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">unit_price_col</span><span class="p">,</span>
                                    <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">unit_price_col</span><span class="p">)</span>
        <span class="c1"># Add each project board total.</span>
        <span class="k">for</span> <span class="n">i_prj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qty</span><span class="p">)):</span>
            <span class="n">qty_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty_prj</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">)][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">total_cost_row</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">i_prj</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span>
                      <span class="s1">&#39;=SUMPRODUCT(</span><span class="si">{qty_range}</span><span class="s1">,</span><span class="si">{unit_price_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">unit_price_range</span><span class="o">=</span><span class="n">unit_price_range</span><span class="p">,</span>
                            <span class="n">qty_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">qty_col</span><span class="p">,</span>
                                <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">qty_col</span><span class="p">)),</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">])</span>
        <span class="c1"># Add total of the spreadsheet, this can be equal or bigger than</span>
        <span class="c1"># than the sum of the above totals, because, in the case of partial</span>
        <span class="c1"># or fractional quantity of one part or subpart, the total quantity</span>
        <span class="c1"># column &#39;qty&#39; will be the ceil of the sum of the other ones.</span>
        <span class="n">total_cost_row</span> <span class="o">=</span> <span class="n">start_row</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Change the position of the total price cell.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">total_cost_row</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span> <span class="s1">&#39;=SUM(</span><span class="si">{sum_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">sum_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span>
                           <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">)),</span>
              <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">])</span>

    <span class="c1"># Add the total purchase and others purchase informations.</span>
    <span class="k">if</span> <span class="n">distributor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">next_line</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;Total Purchase:&#39;</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_label&#39;</span><span class="p">])</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;This is the total of your cart across all distributors.&#39;</span><span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;=SUM(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dist_ext_prices</span><span class="p">)),</span>
              <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">])</span>
        <span class="c1"># Purchase general description, it may be used to distinguish carts of different projects.</span>
        <span class="n">next_line</span> <span class="o">=</span> <span class="n">next_line</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;Purchase description:&#39;</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;This description will be added to all purchased parts label and may be used to distinguish the component of different projects.&#39;</span><span class="p">)</span>
        <span class="n">WORKBOOK</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span><span class="s1">&#39;PURCHASE_DESCRIPTION&#39;</span><span class="p">,</span>
            <span class="s1">&#39;=</span><span class="si">{wks_name}</span><span class="s1">!</span><span class="si">{cell_ref}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">wks_name</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">WORKSHEET_NAME</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                <span class="n">cell_ref</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                                       <span class="n">row_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

    <span class="c1"># Get the actual currency rate to use.</span>
    <span class="n">next_line</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">used_currencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">used_currencies</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEBUG_OVERVIEW</span><span class="p">,</span> <span class="s1">&#39;Getting distributor currency convertion rate </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">used_currencies</span><span class="p">,</span> <span class="n">CURRENCY_ALPHA3</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_currencies</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">CURRENCY_ALPHA3</span> <span class="ow">in</span> <span class="n">used_currencies</span><span class="p">:</span>
            <span class="n">used_currencies</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">CURRENCY_ALPHA3</span><span class="p">)</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Used currency rates:&#39;</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
        <span class="n">next_line</span> <span class="o">=</span> <span class="n">next_line</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">used_currency</span> <span class="ow">in</span> <span class="n">used_currencies</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">used_currency</span><span class="o">!=</span><span class="n">CURRENCY_ALPHA3</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;</span><span class="si">{c}</span><span class="s1">(</span><span class="si">{c_s}</span><span class="s1">)/</span><span class="si">{d}</span><span class="s1">(</span><span class="si">{d_s}</span><span class="s1">):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">CURRENCY_ALPHA3</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">used_currency</span><span class="p">,</span> <span class="n">c_s</span><span class="o">=</span><span class="n">CURRENCY_SYMBOL</span><span class="p">,</span>
                                    <span class="n">d_s</span><span class="o">=</span><span class="n">numbers</span><span class="o">.</span><span class="n">get_currency_symbol</span><span class="p">(</span><span class="n">used_currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)</span>
                                  <span class="p">),</span>
                        <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
                      <span class="p">)</span>
            <span class="n">WORKBOOK</span><span class="o">.</span><span class="n">define_name</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{c}</span><span class="s1">_</span><span class="si">{d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">CURRENCY_ALPHA3</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">used_currency</span><span class="p">),</span>
                <span class="s1">&#39;=</span><span class="si">{wks_name}</span><span class="s1">!</span><span class="si">{cell_ref}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">wks_name</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">WORKSHEET_NAME</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                    <span class="n">cell_ref</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                           <span class="n">row_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">currency_convert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">used_currency</span><span class="p">,</span> <span class="n">CURRENCY_ALPHA3</span><span class="p">)</span>
                      <span class="p">)</span>
            <span class="n">next_line</span> <span class="o">=</span> <span class="n">next_line</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Return column following the globals so we know where to start next set of cells.</span>
    <span class="c1"># Also return the columns where the references and quantity needed of each part is stored.</span>
    <span class="k">return</span> <span class="n">next_line</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;refs&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">columns</span>


<span class="k">def</span> <span class="nf">add_dist_to_worksheet</span><span class="p">(</span><span class="n">wks</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">,</span> <span class="n">columns_global</span><span class="p">,</span> <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span>
                          <span class="n">unit_cost_row</span><span class="p">,</span> <span class="n">total_cost_row</span><span class="p">,</span> <span class="n">part_ref_col</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="p">,</span>
                          <span class="n">dist</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">supress_cat_url</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Add distributor-specific part data to the spreadsheet.&#39;&#39;&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEBUG_OVERVIEW</span><span class="p">,</span> <span class="s1">&#39;# Writing </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]))</span>

    <span class="k">global</span> <span class="n">CURRENCY_ALPHA3</span>

    <span class="c1"># Columns for the various types of distributor-specific part data.</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;avail&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1"># column offset within this distributor range of the worksheet.</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Outline level (or hierarchy level) for this column.</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Avail&#39;</span><span class="p">,</span>  <span class="c1"># Column header label.</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Column width (default in this case).</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;Available quantity of each part at the distributor.</span>
<span class="s1">Red -&gt; No quantity available.</span>
<span class="s1">Orange -&gt; Too little quantity available.&#39;&#39;&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;purch&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Purch&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Purchase quantity of each part from this distributor.</span><span class="se">\n</span><span class="s1">Yellow -&gt; This part have a minimum purchase quantity bigger than 1 (check the price breaks).</span><span class="se">\n</span><span class="s1">Red -&gt; Purchasing more than the available quantity.&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;unit_price&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit price of each part from this distributor.</span><span class="se">\n</span><span class="s1">Green -&gt; lowest price across distributors.&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;ext_price&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Ext$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>  <span class="c1"># Displays up to $9,999,999.99 without &quot;###&quot;.</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;(Unit Price) x (Purchase Qty) of each part from this distributor.</span><span class="se">\n</span><span class="s1">Red -&gt; Next price break is cheaper.</span><span class="se">\n</span><span class="s1">Green -&gt; Cheapest supplier.&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;part_num&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Cat#&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Distributor-assigned catalog number for each part and link to it</span><span class="se">\&#39;</span><span class="s1">s web page (ctrl-click). Extra distributor data is shown as comment.&#39;</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">supress_cat_url</span><span class="p">:</span>
        <span class="c1"># Add a extra column to the hiperlink.</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;URL&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Distributor catalog link (ctrl-click).&#39;</span>
                        <span class="p">}})</span>
        <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Distributor-assigned catalog number for each part. Extra distributor data is shown as comment.&#39;</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">start_row</span>  <span class="c1"># Start building distributor section at this row.</span>

    <span class="c1"># Add label for this distributor.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="c1">#distributor_dict[dist][&#39;label&#39;][&#39;name&#39;].title(),</span>
            <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">wrk_formats</span><span class="p">[</span><span class="n">dist</span><span class="p">])</span>
    <span class="c1">#if distributor_dict[dist][&#39;type&#39;]!=&#39;local&#39;:</span>
    <span class="c1">#    wks.write_url(row, start_col,</span>
    <span class="c1">#        distributor_dict[dist][&#39;label&#39;][&#39;url&#39;], wrk_formats[dist],</span>
    <span class="c1">#        distributor_dict[dist][&#39;label&#39;][&#39;name&#39;].title())</span>
    <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="c1"># Add column headers, comments, and outline level (for hierarchy).</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>  <span class="c1"># Column index for this column.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">])</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;level&#39;</span><span class="p">]})</span>
    <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="n">num_parts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
    <span class="c1"># For check the number of BOM files read, see the length of p[?][&#39;manf#_qty&#39;],</span>
    <span class="c1"># if it is a `list()` instance, if don&#39;t, the lenth is always `1`.</span>
    <span class="n">num_prj</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;manf#_qty&#39;</span><span class="p">,[]))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;manf#_qty&#39;</span><span class="p">,[]),</span><span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">])</span>

    <span class="c1"># Add distributor data for each part.</span>
    <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">=</span> <span class="n">row</span>  <span class="c1"># Starting row of part info.</span>
    <span class="n">PART_INFO_LAST_ROW</span> <span class="o">=</span> <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Last row of part info.</span>

    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>

        <span class="n">dist_part_num</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">part_num</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span> <span class="c1"># Get the distributor part number.</span>
        <span class="n">price_tiers</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">price_tiers</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span> <span class="c1"># Extract price tiers from distributor HTML page tree.</span>
        <span class="n">dist_currency</span> <span class="o">=</span>  <span class="n">part</span><span class="o">.</span><span class="n">currency</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span> <span class="c1"># Extract currency used by the distributor.</span>

        <span class="c1"># If the part number doesn&#39;t exist, just leave this row blank.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist_part_num</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Skip this row and go to the next.</span>
            <span class="k">continue</span>

        <span class="c1"># if len(dist_part_num) == 0 or part.qty_avail[dist] is None or len(list(price_tiers.keys())) == 0:</span>
            <span class="c1"># row += 1  # Skip this row and go to the next.</span>
            <span class="c1"># continue</span>

        <span class="c1"># Enter distributor part number for ordering purposes.</span>
        <span class="k">if</span> <span class="n">dist_part_num</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">dist_part_num</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">supress_cat_url</span><span class="p">:</span>
                <span class="n">dist_part_num</span> <span class="o">=</span> <span class="s1">&#39;Link&#39;</span> <span class="c1"># To use as text for the link.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Add a comment in the &#39;cat#&#39; column with extra informations gotten in the distributor web page.</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span> <span class="n">k</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="o">+</span><span class="n">SEPRTR</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">info_dist</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">EXTRA_INFO_DISPLAY</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">comment</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Enter a link to the distributor webpage for this part, even if there</span>
        <span class="c1"># is no valid quantity or pricing for the part (see next conditional).</span>
        <span class="c1"># Having the link present will help debug if the extraction of the</span>
        <span class="c1"># quantity or pricing information was done correctly.</span>
        <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="n">dist</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">supress_cat_url</span><span class="p">:</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="n">dist</span><span class="p">],</span> <span class="n">string</span><span class="o">=</span><span class="n">dist_part_num</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">write_url</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">part</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="n">dist</span><span class="p">])</span>

        <span class="c1"># Enter quantity of part available at this distributor unless it is None</span>
        <span class="c1"># which means the part is not stocked.</span>
        <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">qty_avail</span><span class="p">[</span><span class="n">dist</span><span class="p">]:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                  <span class="n">part</span><span class="o">.</span><span class="n">qty_avail</span><span class="p">[</span><span class="n">dist</span><span class="p">],</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;part_format&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="s1">&#39;NonStk&#39;</span><span class="p">,</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;not_stocked&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> 
                <span class="s1">&#39;This part is listed but is not normally stocked.&#39;</span><span class="p">)</span>

        <span class="c1"># Purchase quantity always starts as blank because nothing has been purchased yet.</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Add pricing information if it exists.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">price_tiers</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Add the price for a single unit if it doesn&#39;t already exist in the tiers.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">min_qty</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">price_tiers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">minimum_order_qty</span> <span class="o">=</span> <span class="n">min_qty</span> <span class="c1"># Update the minimum order quantity.</span>
                <span class="k">if</span> <span class="n">min_qty</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">price_tiers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_tiers</span><span class="p">[</span><span class="n">min_qty</span><span class="p">]</span> <span class="c1"># Set unit price to price of lowest available quantity.</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># This happens if the price tier list is empty.</span>
                <span class="k">pass</span>
            <span class="n">price_tiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00</span>  <span class="c1"># Enter quantity-zero pricing so `LOOKUP` works correctly in the spreadsheet.</span>

            <span class="c1"># Sort the tiers based on quantities and turn them into lists of strings.</span>
            <span class="n">qtys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">price_tiers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="n">avail_qty_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
            <span class="n">purch_qty_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
            <span class="n">unit_price_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
            <span class="n">ext_price_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>

            <span class="c1"># Enter a spreadsheet lookup function that determines the unit price based on the needed quantity</span>
            <span class="c1"># or the purchased quantity (if that is non-zero).</span>
            <span class="k">if</span> <span class="n">dist_currency</span><span class="o">==</span><span class="n">CURRENCY_ALPHA3</span><span class="p">:</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">,</span> <span class="n">unit_price_col</span><span class="p">,</span>
                    <span class="s1">&#39;=iferror(lookup(if(</span><span class="si">{purch_qty}</span><span class="s1">=&quot;&quot;,</span><span class="si">{needed_qty}</span><span class="s1">,</span><span class="si">{purch_qty}</span><span class="s1">),{{</span><span class="si">{qtys}</span><span class="s1">}},{{</span><span class="si">{prices}</span><span class="s1">}}),&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">needed_qty</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="p">),</span>
                        <span class="n">purch_qty</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">),</span>
                        <span class="n">qtys</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qtys</span><span class="p">]),</span>
                        <span class="n">prices</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">price_tiers</span><span class="p">[</span><span class="n">q</span><span class="p">])</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qtys</span><span class="p">])),</span>
                        <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">,</span> <span class="n">unit_price_col</span><span class="p">,</span>
                    <span class="s1">&#39;=iferror(</span><span class="si">{rate}</span><span class="s1">*lookup(if(</span><span class="si">{purch_qty}</span><span class="s1">=&quot;&quot;,</span><span class="si">{needed_qty}</span><span class="s1">,</span><span class="si">{purch_qty}</span><span class="s1">),{{</span><span class="si">{qtys}</span><span class="s1">}},{{</span><span class="si">{prices}</span><span class="s1">}}),&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">rate</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{c}</span><span class="s1">_</span><span class="si">{d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">CURRENCY_ALPHA3</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dist_currency</span><span class="p">),</span> <span class="c1"># Currency rate used to this distributor.</span>
                        <span class="n">needed_qty</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="p">),</span>
                        <span class="n">purch_qty</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">),</span>
                        <span class="n">qtys</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qtys</span><span class="p">]),</span>
                        <span class="n">prices</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">price_tiers</span><span class="p">[</span><span class="n">q</span><span class="p">])</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qtys</span><span class="p">])),</span>
                        <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">])</span>

            <span class="c1"># Add a comment to the cell showing the qty/price breaks.</span>
            <span class="n">dist_currency_symbol</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">get_currency_symbol</span><span class="p">(</span><span class="n">dist_currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)</span>
            <span class="n">price_break_info</span> <span class="o">=</span> <span class="s1">&#39;Qty/Price Breaks (</span><span class="si">{c}</span><span class="s1">):</span><span class="se">\n</span><span class="s1">  Qty  -  Unit</span><span class="si">{s}</span><span class="s1">  -  Ext</span><span class="si">{s}</span><span class="se">\n</span><span class="s1">================&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">dist_currency</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">dist_currency_symbol</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qtys</span><span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">minimum_order_qty</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">2</span><span class="p">:]:</span>
                <span class="c1"># Skip the unity quantity for the tip balloon if it not allow to purchase in the distributor.</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">price_tiers</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
                <span class="n">price_break_info</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:&gt;6d}</span><span class="s1"> </span><span class="si">{:&gt;7s}</span><span class="s1"> </span><span class="si">{:&gt;10s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">q</span><span class="p">,</span>
                    <span class="n">numbers</span><span class="o">.</span><span class="n">format_currency</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">dist_currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">),</span>
                    <span class="n">numbers</span><span class="o">.</span><span class="n">format_currency</span><span class="p">(</span><span class="n">price</span><span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">dist_currency</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">))</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">unit_price_col</span><span class="p">,</span> <span class="n">price_break_info</span><span class="p">)</span>

            <span class="c1"># Conditional format to show no quantity is available.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> 
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;not_available&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Conditional format to show the available quantity is less than required.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> 
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;avail&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="p">),</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;too_few_available&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Conditional format to show that the part have a minimum order quantity not respected.</span>
            <span class="k">if</span> <span class="n">minimum_order_qty</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> 
                    <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;formula&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;=AND(</span><span class="si">{q}</span><span class="s1">&gt;0,</span><span class="si">{q}</span><span class="s1">&lt;</span><span class="si">{moq}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">q</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]),</span>
                            <span class="n">moq</span><span class="o">=</span><span class="n">minimum_order_qty</span>
                        <span class="p">),</span>
                        <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;order_min_qty&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="c1"># Conditional format to show the purchase quantity is more than what is available.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> 
                <span class="n">row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">],</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">avail_qty_col</span><span class="p">),</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;order_too_much&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># Enter the formula for the extended price = purch qty * unit price.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span>
                <span class="n">row</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">,</span>
                <span class="s1">&#39;=iferror(if(</span><span class="si">{purch_qty}</span><span class="s1">=&quot;&quot;,</span><span class="si">{needed_qty}</span><span class="s1">,</span><span class="si">{purch_qty}</span><span class="s1">)*</span><span class="si">{unit_price}</span><span class="s1">,&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">needed_qty</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="p">),</span>
                    <span class="n">purch_qty</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">),</span>
                    <span class="n">unit_price</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">unit_price_col</span><span class="p">)),</span>
                <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">distributor_dict</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Just use the best price highlight if more than one distributor.</span>
                <span class="c1"># Conditionally format the extended price cell that contains the best price.</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span>
                    <span class="c1"># This is the global data cell holding the minimum extended price for this part.</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;best_price&#39;</span><span class="p">]</span>
                <span class="p">})</span>
                <span class="c1"># Conditionally format the unit price cell that contains the best price.</span>
                <span class="n">wks</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">unit_price_col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">unit_price_col</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">part_qty_col</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                    <span class="c1"># This is the global data cell holding the minimum unit price for this part.</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;best_price&#39;</span><span class="p">]</span>
                <span class="p">})</span>

        <span class="c1"># Finished processing distributor data for this part.</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Go to next row.</span>

    <span class="n">total_cost_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">unit_cost_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">dist_cat_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    
    <span class="c1"># If more than one file (multi-files mode) show how many</span>
    <span class="c1"># parts of each BOM as found at this distributor and</span>
    <span class="c1"># the correspondent total price.</span>
    <span class="k">if</span> <span class="n">num_prj</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i_prj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prj</span><span class="p">):</span>
            <span class="c1"># Sum the extended prices (unit multiplied by quantity) for each file/BOM.</span>
            <span class="n">qty_prj_col</span> <span class="o">=</span> <span class="n">part_qty_col</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_prj</span> <span class="o">-</span> <span class="n">i_prj</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">total_cost_row</span> <span class="o">+</span> <span class="n">i_prj</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span>
                      <span class="s1">&#39;=SUMPRODUCT(</span><span class="si">{qty_range}</span><span class="s1">,</span><span class="si">{unit_price_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">qty_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">qty_prj_col</span><span class="p">,</span>
                                            <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">qty_prj_col</span><span class="p">),</span>
                            <span class="n">unit_price_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">unit_cost_col</span><span class="p">,</span>
                                            <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">unit_cost_col</span><span class="p">)),</span>
                      <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">])</span>
            <span class="c1"># Show how many parts were found at this distributor.</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">dist_cat_col</span><span class="p">,</span>
                <span class="s1">&#39;=COUNTIFS(</span><span class="si">{price_range}</span><span class="s1">,&quot;&lt;&gt;&quot;,</span><span class="si">{qty_range}</span><span class="s1">,&quot;&lt;&gt;0&quot;,</span><span class="si">{qty_range}</span><span class="s1">,&quot;&lt;&gt;&quot;)&amp;&quot; of &quot;&amp;COUNTIFS(</span><span class="si">{qty_range}</span><span class="s1">,&quot;&lt;&gt;0&quot;,</span><span class="si">{qty_range}</span><span class="s1">,&quot;&lt;&gt;&quot;)&amp;&quot; parts found&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">price_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span>
                                     <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">),</span>
                <span class="n">qty_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">qty_prj_col</span><span class="p">,</span>
                                   <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">qty_prj_col</span><span class="p">)),</span>
                <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;found_part_pct&#39;</span><span class="p">])</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">dist_cat_col</span><span class="p">,</span> <span class="s1">&#39;Number of parts found at this distributor for the project </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_prj</span><span class="p">))</span>
        <span class="n">total_cost_row</span> <span class="o">=</span> <span class="n">PART_INFO_FIRST_ROW</span> <span class="o">-</span> <span class="mi">3</span> <span class="c1"># Shift the total price in this distributor.</span>
    
    <span class="c1"># Sum the extended prices for all the parts to get the total cost from this distributor.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">total_cost_row</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span> <span class="s1">&#39;=SUM(</span><span class="si">{sum_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">sum_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span>
                           <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">)),</span>
              <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">])</span>
    <span class="c1"># Show how many parts were found at this distributor.</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">total_cost_row</span><span class="p">,</span> <span class="n">dist_cat_col</span><span class="p">,</span>
        <span class="s1">&#39;=(COUNTA(</span><span class="si">{count_range}</span><span class="s1">)&amp;&quot; of &quot;&amp;ROWS(</span><span class="si">{count_range}</span><span class="s1">)&amp;&quot; parts found&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="c1">#&#39;=COUNTIF({count_range},&quot;&lt;&gt;&quot;)&amp;&quot; of &quot;&amp;ROWS({count_range})&amp;&quot; parts found&quot;&#39;.format(</span>
            <span class="n">count_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">,</span>
                                 <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">total_cost_col</span><span class="p">)),</span>
            <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;found_part_pct&#39;</span><span class="p">])</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">total_cost_row</span><span class="p">,</span> <span class="n">dist_cat_col</span><span class="p">,</span> <span class="s1">&#39;Number of parts found at this distributor.&#39;</span><span class="p">)</span>

    <span class="c1"># Add list of part numbers and purchase quantities for ordering from this distributor.</span>
    <span class="n">ORDER_START_COL</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ORDER_FIRST_ROW</span> <span class="o">=</span> <span class="n">PART_INFO_LAST_ROW</span> <span class="o">+</span> <span class="mi">3</span>
    <span class="n">ORDER_LAST_ROW</span> <span class="o">=</span> <span class="n">ORDER_FIRST_ROW</span> <span class="o">+</span> <span class="n">num_parts</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Write the header and how many parts are being purchased.</span>
    <span class="n">purch_qty_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">ext_price_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;ext_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">ORDER_HEADER</span> <span class="o">=</span>  <span class="n">PART_INFO_LAST_ROW</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span> <span class="c1"># Expended many in this distributor.</span>
        <span class="n">ORDER_HEADER</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">,</span>
        <span class="s1">&#39;=SUMIF(</span><span class="si">{count_range}</span><span class="s1">,&quot;&gt;0&quot;,</span><span class="si">{price_range}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">count_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">,</span>
                                 <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">),</span>
            <span class="n">price_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">,</span>
                                 <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;total_cost_currency&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span> <span class="c1"># Quantity of purchased part in this distributor.</span>
        <span class="n">ORDER_HEADER</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">,</span>
        <span class="s1">&#39;=IFERROR(IF(OR(</span><span class="si">{count_range}</span><span class="s1">),COUNTIFS(</span><span class="si">{count_range}</span><span class="s1">,&quot;&gt;0&quot;,</span><span class="si">{count_range_price}</span><span class="s1">,&quot;&lt;&gt;&quot;)&amp;&quot; of &quot;&amp;(ROWS(</span><span class="si">{count_range_price}</span><span class="s1">)-COUNTBLANK(</span><span class="si">{count_range_price}</span><span class="s1">))&amp;&quot; parts purchased&quot;,&quot;&quot;),&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">count_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">,</span>
                                 <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">),</span>
            <span class="n">count_range_price</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">,</span>
                                 <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;found_part_pct&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">ORDER_HEADER</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">,</span>
        <span class="s1">&#39;Copy the information below to the BOM import page of the distributor web site.&#39;</span><span class="p">)</span>


    <span class="c1"># Write the spreadsheet code to multiple lines to create the purchase codes to</span>
    <span class="c1"># be used in this current distributor.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;cols&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="c1"># If not created the distributor definition, jump this final code part.</span>

    <span class="c1"># Create the header of the purchase codes, if present the definition.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wks</span><span class="o">.</span><span class="n">write_formula</span><span class="p">(</span><span class="n">ORDER_FIRST_ROW</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">,</span>
                         <span class="s1">&#39;=IFERROR(IF(COUNTIFS(</span><span class="si">{count_range}</span><span class="s1">,&quot;&gt;0&quot;,</span><span class="si">{count_range_price}</span><span class="s1">,&quot;&lt;&gt;&quot;)&gt;0,&quot;</span><span class="si">{header}</span><span class="s1">&quot;,&quot;&quot;),&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">count_range</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">,</span>
                                <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">purch_qty_col</span><span class="p">),</span>
                            <span class="n">count_range_price</span><span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">,</span>
                                <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">ext_price_col</span><span class="p">),</span>
                            <span class="n">header</span><span class="o">=</span><span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">],</span>
                         <span class="p">),</span>
                         <span class="n">wrk_formats</span><span class="p">[</span><span class="s1">&#39;found_part_pct&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_comment</span><span class="p">(</span><span class="n">ORDER_FIRST_ROW</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">,</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">ORDER_FIRST_ROW</span> <span class="o">=</span> <span class="n">ORDER_FIRST_ROW</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Push all the code list one row.</span>
        <span class="n">ORDER_LAST_ROW</span> <span class="o">=</span> <span class="n">ORDER_LAST_ROW</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;purch&#39;</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;part_num&#39;</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">or</span> <span class="s1">&#39;manf#&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEBUG_OVERVIEW</span><span class="p">,</span> <span class="s2">&quot;Purchase list codes for </span><span class="si">{d}</span><span class="s2"> will not be generated.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">d</span><span class="o">=</span><span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This script enters a function into a spreadsheet cell that</span>
        <span class="c1"># prints the information found in info_col into the order_col column</span>
        <span class="c1"># of the order.</span>
        <span class="c1"># This very complicated spreadsheet function does the following:</span>
        <span class="c1"># 1) Computes the set of row index in the part data that have</span>
        <span class="c1">#    non-empty cells in sel_range1 and sel_range2. (Innermost</span>
        <span class="c1">#    nested IF and ROW commands.) sel_range1 and sel_range2 are</span>
        <span class="c1">#    the part&#39;s catalog number and purchase quantity.</span>
        <span class="c1"># 2) Selects the k&#39;th smallest of the row index where k is the</span>
        <span class="c1">#    number of rows between the current part row in the order and the</span>
        <span class="c1">#    top row of the order. (SMALL() and ROW() commands.)</span>
        <span class="c1"># 3) Gets the cell contents  from the get_range using the k&#39;th</span>
        <span class="c1">#    smallest row index found in step #2. (INDEX() command.)</span>
        <span class="c1"># 4) Converts the cell contents to a string if it is numeric.</span>
        <span class="c1">#    (num_to_text_func is used.) Otherwise, it&#39;s already a string.</span>
        <span class="c1"># 5) CONCATENATES the string from step #4 with the delimiter</span>
        <span class="c1">#    that goes between fields of an order for a part.</span>
        <span class="c1">#    (CONCATENATE() command.)</span>
        <span class="c1"># 6) If any error occurs (which usually means the indexed cell</span>
        <span class="c1">#    contents were blank), then a blank is printed. Otherwise,</span>
        <span class="c1">#    the string from step #5 is printed in this cell.</span>
        <span class="n">order_func</span> <span class="o">=</span> <span class="s1">&#39;IFERROR(CONCATENATE(</span><span class="si">{}</span><span class="s1">),&quot;&quot;)&#39;</span>
        <span class="n">order_info_func_model</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        INDEX(</span>
<span class="s1">                            </span><span class="si">{get_range}</span><span class="s1">,</span>
<span class="s1">                            SMALL(</span>
<span class="s1">                                IF( ISNUMBER(</span><span class="si">{qty}</span><span class="s1">),</span>
<span class="s1">                                    IF( </span><span class="si">{qty}</span><span class="s1"> &gt; 0,</span>
<span class="s1">                                        IF( </span><span class="si">{code}</span><span class="s1"> &lt;&gt; &quot;&quot;,</span>
<span class="s1">                                            ROW(</span><span class="si">{qty}</span><span class="s1">) - MIN(ROW(</span><span class="si">{qty}</span><span class="s1">)) + 1</span>
<span class="s1">                                        )</span>
<span class="s1">                                    )</span>
<span class="s1">                                ),</span>
<span class="s1">                                ROW()-ROW(</span><span class="si">{order_first_row}</span><span class="s1">)+1</span>
<span class="s1">                            )</span>
<span class="s1">                        )</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="n">order_info_func_model</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[\s</span><span class="se">\n</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">order_info_func_model</span><span class="p">)</span> <span class="c1"># Strip all the whitespace from the function string.</span>

        <span class="c1"># Create the line order by the fields specified by each distributor.</span>
        <span class="n">delimier</span> <span class="o">=</span> <span class="s1">&#39;,&quot;&#39;</span> <span class="o">+</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;delimiter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&#39;</span> <span class="c1"># Function delimiter plus distributor code delimiter.</span>
        <span class="n">order_part_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="c1"># Deal with conversion and string replace necessary to the correct distributors</span>
            <span class="c1"># code understanding.</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">==</span><span class="s1">&#39;purch&#39;</span><span class="p">:</span>
                <span class="c1"># Add text conversion if is a numeric cell.</span>
                <span class="n">order_part_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;TEXT(</span><span class="si">{}</span><span class="s1">,&quot;##0&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">order_info_func_model</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">,</span> <span class="s1">&#39;purch&#39;</span><span class="p">,</span> <span class="s1">&#39;manf#&#39;</span><span class="p">]:</span>
                <span class="c1"># All comment and description columns (that are not quantity and catalogue code)</span>
                <span class="c1"># should respect the allowed characters. These are text informative columns.</span>
                <span class="c1">#if col==&#39;refs&#39;:</span>
                <span class="c1">#    # If &#39;refs&#39; column an additional rule to remove the subpart counter.</span>
                <span class="c1">#    order_info_func_parcial = &#39;REGEX({f},&quot;\{c}\d+&quot;,&quot;&quot;,&quot;g&quot;)&#39;.format(f=order_info_func_model,c=SUB_SEPRTR)</span>
                <span class="c1">#    This is not supported by Microsoft Excel. ## TODO</span>
                <span class="c1">#else:</span>
                <span class="n">order_info_func_parcial</span> <span class="o">=</span> <span class="n">order_info_func_model</span>
                <span class="k">if</span> <span class="s1">&#39;not_allowed_char&#39;</span> <span class="ow">in</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;replace_by_char&#39;</span> <span class="ow">in</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;not_allowed_char&#39;</span><span class="p">])):</span>
                        <span class="n">not_allowed_char</span> <span class="o">=</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;not_allowed_char&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;replace_by_char&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">replace_by_char</span> <span class="o">=</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;replace_by_char&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">replace_by_char</span> <span class="o">=</span> <span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;replace_by_char&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">order_info_func_parcial</span> <span class="o">=</span> <span class="s1">&#39;SUBSTITUTE(</span><span class="si">{t}</span><span class="s1">,&quot;</span><span class="si">{o}</span><span class="s1">&quot;,&quot;</span><span class="si">{n}</span><span class="s1">&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">t</span><span class="o">=</span><span class="n">order_info_func_parcial</span><span class="p">,</span>
                                <span class="n">o</span><span class="o">=</span><span class="n">not_allowed_char</span><span class="p">,</span>
                                <span class="n">n</span><span class="o">=</span><span class="n">replace_by_char</span><span class="p">)</span>
                <span class="n">order_part_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_info_func_parcial</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order_part_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_info_func_model</span><span class="p">)</span>
            <span class="c1"># Look for the `col` name into the distributor spreadsheet part</span>
            <span class="c1"># with don&#39;t find, it belongs to the global part.</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="n">info_range</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_global</span><span class="p">:</span>
                <span class="n">info_range</span> <span class="o">=</span> <span class="n">columns_global</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info_range</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not valid field `</span><span class="si">{f}</span><span class="s2">` for purchase list at </span><span class="si">{d}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">f</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                            <span class="n">d</span><span class="o">=</span><span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="p">))</span>
            <span class="n">info_range</span> <span class="o">=</span><span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">info_range</span><span class="p">,</span>
                                 <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">info_range</span><span class="p">)</span>
            <span class="c1"># If the correspondent information is some description, it is allow to add the general</span>
            <span class="c1"># purchase designator. it is placed inside the &quot;not allow characters&quot; restriction.</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">,</span> <span class="s1">&#39;purch&#39;</span><span class="p">,</span> <span class="s1">&#39;manf#&#39;</span><span class="p">]:</span>
                <span class="n">info_range</span> <span class="o">=</span> <span class="s1">&#39;IF(PURCHASE_DESCRIPTION&lt;&gt;&quot;&quot;,PURCHASE_DESCRIPTION&amp;&quot;</span><span class="si">{}</span><span class="s1">&quot;,&quot;&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PURCHASE_DESCRIPTION_SEPRTR</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span> <span class="n">info_range</span>
            <span class="c1"># Create the part of formula that refers with one specific information.</span>
            <span class="n">order_part_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">order_part_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">get_range</span><span class="o">=</span><span class="n">info_range</span><span class="p">,</span>
                        <span class="n">qty</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{qty}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="c1"># keep all other for future replacement.</span>
                        <span class="n">code</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{code}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">order_first_row</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{order_first_row}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># If already have some information, add the delimiter for</span>
        <span class="c1"># Microsoft Excel/LibreOffice Calc function.</span>
        <span class="n">order_func</span> <span class="o">=</span> <span class="n">order_func</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">delimier</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_part_info</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># These are the columns where the part catalog numbers and purchase quantities can be found.</span>
        <span class="k">if</span> <span class="s1">&#39;part_num&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">purchase_code</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;part_num&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;manf#&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">purchase_code</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns_global</span><span class="p">[</span><span class="s1">&#39;manf#&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">purchase_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not valid  quantity/code field `</span><span class="si">{f}</span><span class="s2">` for purchase list at </span><span class="si">{d}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">f</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                        <span class="n">d</span><span class="o">=</span><span class="n">distributor_dict</span><span class="p">[</span><span class="n">dist</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="p">))</span>
        <span class="n">purchase_code</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">purchase_code</span><span class="p">,</span>
                                 <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">purchase_code</span><span class="p">)</span>
        <span class="n">purchase_qty</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;purch&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="n">purchase_qty</span> <span class="o">=</span> <span class="n">xl_range</span><span class="p">(</span><span class="n">PART_INFO_FIRST_ROW</span><span class="p">,</span> <span class="n">purchase_qty</span><span class="p">,</span>
                                <span class="n">PART_INFO_LAST_ROW</span><span class="p">,</span> <span class="n">purchase_qty</span><span class="p">)</span>
        <span class="c1"># Fill the formula with the control parameters.</span>
        <span class="n">order_func</span> <span class="o">=</span> <span class="n">order_func</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">order_first_row</span><span class="o">=</span><span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="n">ORDER_FIRST_ROW</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">row_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                        <span class="n">code</span><span class="o">=</span><span class="n">purchase_code</span><span class="p">,</span>
                        <span class="n">qty</span><span class="o">=</span><span class="n">purchase_qty</span>
                    <span class="p">)</span>
        <span class="c1"># Now write the order_func into every row of the order in the given column.</span>
        <span class="n">dist_col</span> <span class="o">=</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="n">info_col</span> <span class="o">=</span> <span class="n">dist_col</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ORDER_FIRST_ROW</span><span class="p">,</span> <span class="n">ORDER_LAST_ROW</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">wks</span><span class="o">.</span><span class="n">write_array_formula</span><span class="p">(</span>
                <span class="n">xl_range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">ORDER_START_COL</span><span class="p">),</span> <span class="s1">&#39;{{=</span><span class="si">{f}</span><span class="s1">}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">order_func</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">start_col</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="c1"># Return column following the globals so we know where to start next set of cells.</span>


<span class="k">def</span> <span class="nf">remove_column</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Remove a speficied columns from a create table.&#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]:</span>
            <span class="n">table</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">del</span> <span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">table</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">kicost 1.1.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, XESS Corporation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.
    </div>
  </body>
</html>